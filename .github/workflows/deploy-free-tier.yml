name: Deploy Demo to AWS Free Tier

on:
  workflow_dispatch:
    inputs:
      key_pair_name:
        description: 'SSH Key Pair Name'
        required: true
        default: 'apollo-demo-key'
      aws_region:
        description: 'AWS Region'
        required: true
        default: 'us-east-1'
        type: choice
        options:
        - us-east-1
        - us-west-2
        - eu-west-1
        - ap-southeast-1

jobs:
  deploy-demo:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Build and push Docker images
        run: |
          # Convert repository name to lowercase
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          # Build and push API image
          docker build -f Dockerfile.api -t ghcr.io/${REPO_OWNER}/apollo-search-api:latest .
          docker push ghcr.io/${REPO_OWNER}/apollo-search-api:latest
          
          # Build and push UI image
          docker build -f Dockerfile.ui -t ghcr.io/${REPO_OWNER}/apollo-search-ui:latest .
          docker push ghcr.io/${REPO_OWNER}/apollo-search-ui:latest    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ github.event.inputs.aws_region }}
        
    - name: Create SSH Key Pair if needed
      run: |
        if ! aws ec2 describe-key-pairs --key-names ${{ github.event.inputs.key_pair_name }} --region ${{ github.event.inputs.aws_region }} 2>/dev/null; then
          echo "Creating SSH key pair..."
          aws ec2 create-key-pair \
            --key-name ${{ github.event.inputs.key_pair_name }} \
            --region ${{ github.event.inputs.aws_region }} \
            --query 'KeyMaterial' \
            --output text > ${{ github.event.inputs.key_pair_name }}.pem
          echo "SSH key created: ${{ github.event.inputs.key_pair_name }}.pem"
        else
          echo "SSH key pair already exists"
        fi
        
    - name: Deploy Free Tier Stack
      run: |
        MEILI_MASTER_KEY="demo-$(openssl rand -hex 12)"
        echo "Generated MEILI_MASTER_KEY: $MEILI_MASTER_KEY"
        
        echo "Validating CloudFormation template..."
        aws cloudformation validate-template \
          --template-body file://aws/cloudformation-free-tier-no-iam.yml \
          --region ${{ github.event.inputs.aws_region }}
        
        echo "Deploying CloudFormation stack..."
        aws cloudformation deploy \
          --template-file aws/cloudformation-free-tier-no-iam.yml \
          --stack-name apollo-search-demo-simple \
          --parameter-overrides \
            ProjectName=apollo-search-demo \
            MeiliMasterKey=$MEILI_MASTER_KEY \
            KeyPairName=${{ github.event.inputs.key_pair_name }} \
          --region ${{ github.event.inputs.aws_region }} \
          --no-fail-on-empty-changeset
          
    - name: Handle Deployment Failure
      if: failure()
      run: |
        echo "Deployment failed. Getting stack events..."
        aws cloudformation describe-stack-events \
          --stack-name apollo-search-demo-simple \
          --region ${{ github.event.inputs.aws_region }} \
          --query "StackEvents[?ResourceStatus=='CREATE_FAILED' || ResourceStatus=='UPDATE_FAILED'].{Time:Timestamp,Status:ResourceStatus,Reason:ResourceStatusReason,Resource:LogicalResourceId}" \
          --output table || echo "Could not retrieve stack events"
          
        echo "Getting stack status..."
        aws cloudformation describe-stacks \
          --stack-name apollo-search-demo-simple \
          --region ${{ github.event.inputs.aws_region }} \
          --query "Stacks[0].StackStatus" \
          --output text || echo "Could not retrieve stack status"
          
    - name: Get Deployment Info
      id: deployment-info
      run: |
        PUBLIC_IP=$(aws cloudformation describe-stacks \
          --stack-name apollo-search-demo-simple \
          --region ${{ github.event.inputs.aws_region }} \
          --query "Stacks[0].Outputs[?OutputKey=='PublicIP'].OutputValue" \
          --output text)
        
        UI_URL=$(aws cloudformation describe-stacks \
          --stack-name apollo-search-demo-simple \
          --region ${{ github.event.inputs.aws_region }} \
          --query "Stacks[0].Outputs[?OutputKey=='UIUrl'].OutputValue" \
          --output text)
        
        API_URL=$(aws cloudformation describe-stacks \
          --stack-name apollo-search-demo-simple \
          --region ${{ github.event.inputs.aws_region }} \
          --query "Stacks[0].Outputs[?OutputKey=='APIUrl'].OutputValue" \
          --output text)
        
        echo "public-ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
        echo "ui-url=$UI_URL" >> $GITHUB_OUTPUT
        echo "api-url=$API_URL" >> $GITHUB_OUTPUT
        
    - name: Create Deployment Summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ðŸš€ Apollo Search Demo Deployed Successfully!
        
        ## ðŸ’° Cost: \$0.00 (AWS Free Tier)
        
        ## ðŸŒ Access URLs:
        - **Search UI**: [${{ steps.deployment-info.outputs.ui-url }}](${{ steps.deployment-info.outputs.ui-url }})
        - **API Docs**: [${{ steps.deployment-info.outputs.api-url }}](${{ steps.deployment-info.outputs.api-url }})
        - **Instance IP**: ${{ steps.deployment-info.outputs.public-ip }}
        
        ## ðŸ”§ SSH Access:
        ```bash
        ssh -i ${{ github.event.inputs.key_pair_name }}.pem ec2-user@${{ steps.deployment-info.outputs.public-ip }}
        ```
        
        ## ðŸ“ Management:
        - **Project Directory**: /opt/apollo-search
        - **Start Services**: sudo systemctl start apollo-search
        - **View Logs**: sudo docker-compose -f /opt/apollo-search/docker-compose.yml logs -f
        
        ## ðŸ—‘ï¸ Cleanup:
        ```bash
        aws cloudformation delete-stack --stack-name apollo-search-demo-simple --region ${{ github.event.inputs.aws_region }}
        aws ec2 delete-key-pair --key-name ${{ github.event.inputs.key_pair_name }} --region ${{ github.event.inputs.aws_region }}
        ```
        
        âš ï¸ **Note**: Allow 2-3 minutes for services to fully start up after deployment.
        EOF
