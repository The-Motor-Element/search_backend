<!DOCTYPE html>
<html>
<head>
    <title>Minimal Search Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-card { border: 1px solid #ddd; margin-bottom: 15px; padding: 15px; border-radius: 5px; }
        .debug-info { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container mt-3">
        <h2>Minimal Search Test</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Search Query:</label>
                    <input type="text" id="searchQuery" class="form-control" value="LOADSTAR" placeholder="Enter search term">
                </div>
                <div class="mb-3">
                    <label class="form-label">Search Type:</label>
                    <select id="searchType" class="form-select">
                        <option value="basic">Basic Search</option>
                        <option value="faceted" selected>Faceted Search</option>
                    </select>
                </div>
                <button onclick="performMinimalSearch()" class="btn btn-primary">Search</button>
                <button onclick="clearResults()" class="btn btn-secondary">Clear</button>
            </div>
        </div>
        
        <div id="debugInfo" class="debug-info"></div>
        <div id="searchResults" class="mt-3"></div>
    </div>
    
    <script>
        function debugLog(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            console.log(message);
        }
        
        function clearResults() {
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('debugInfo').innerHTML = '';
        }
        
        async function performMinimalSearch() {
            debugLog("üîç Starting minimal search...");
            
            const query = document.getElementById('searchQuery').value.trim();
            const searchType = document.getElementById('searchType').value;
            const resultsContainer = document.getElementById('searchResults');
            
            debugLog(`Query: "${query}", Type: ${searchType}`);
            
            // Show loading
            resultsContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><span class="ms-2">Searching...</span></div>';
            
            try {
                let apiUrl;
                let results;
                
                if (searchType === 'faceted') {
                    apiUrl = `http://localhost:8001/search/facets?q=${encodeURIComponent(query)}&facets=group,record_type,ply_rating&limit=10`;
                } else {
                    apiUrl = `http://localhost:8001/search?q=${encodeURIComponent(query)}&limit=10`;
                }
                
                debugLog(`API URL: ${apiUrl}`);
                
                const response = await fetch(apiUrl);
                debugLog(`Response status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                results = await response.json();
                debugLog(`‚úÖ API Response received: ${results.hits?.length || 0} hits`);
                
                // Display results
                displayResults(results);
                
                // Display facets if available
                if (results.facet_distribution) {
                    displayFacets(results.facet_distribution);
                }
                
            } catch (error) {
                debugLog(`‚ùå Search failed: ${error.message}`);
                resultsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Search Error</h5>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Query:</strong> "${query}"</p>
                    </div>
                `;
            }
        }
        
        function displayResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (!results.hits || results.hits.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-info">
                        No results found for "${results.query}".
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="alert alert-success">
                    <h5>Search Results</h5>
                    <p>Found ${results.hits.length} results for "<strong>${results.query}</strong>" 
                       ${results.processing_time_ms ? `(${results.processing_time_ms}ms)` : ''}</p>
                </div>
                <div class="row">
            `;
            
            results.hits.forEach((product, index) => {
                html += createProductCard(product, index);
            });
            
            html += '</div>';
            resultsContainer.innerHTML = html;
            
            debugLog(`‚úÖ Displayed ${results.hits.length} results`);
        }
        
        function createProductCard(product, index) {
            const title = product.title || product.pattern_model || 'Unknown Product';
            const category = product.category || 'Unknown Category';
            const brand = product.brand || 'Unknown Brand';
            const size = product.size || 'N/A';
            const group = product.group || 'Unknown';
            const recordType = product.record_type || 'Unknown';
            
            return `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="product-card">
                        <h6 class="text-primary">${title}</h6>
                        <p class="mb-1"><strong>Brand:</strong> ${brand}</p>
                        <p class="mb-1"><strong>Size:</strong> ${size}</p>
                        <p class="mb-1"><strong>Category:</strong> ${category}</p>
                        <p class="mb-1"><strong>Group:</strong> ${group}</p>
                        <p class="mb-0"><strong>Type:</strong> ${recordType}</p>
                    </div>
                </div>
            `;
        }
        
        function displayFacets(facetDistribution) {
            let facetsHtml = '<div class="mt-3"><h5>Facets:</h5>';
            
            Object.entries(facetDistribution).forEach(([field, values]) => {
                facetsHtml += `<h6>${field}:</h6><ul>`;
                Object.entries(values).forEach(([value, count]) => {
                    facetsHtml += `<li>${value} (${count})</li>`;
                });
                facetsHtml += '</ul>';
            });
            
            facetsHtml += '</div>';
            document.getElementById('searchResults').innerHTML += facetsHtml;
            
            debugLog(`‚úÖ Displayed facets for ${Object.keys(facetDistribution).length} fields`);
        }
        
        debugLog("Minimal search test loaded. Enter a query and click Search.");
    </script>
</body>
</html>
