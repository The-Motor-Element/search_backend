<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apollo Tire Search - Advanced Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-tire"></i> Apollo Tire Search - Advanced Features Demo
            </span>
            <div class="navbar-text">
                <span id="health-status" class="badge bg-success">
                    <i class="fas fa-check-circle"></i> System Healthy
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Search Controls Sidebar -->
            <div class="col-md-3 search-controls-container">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-search"></i> Search Controls</h5>
                    </div>
                    <div class="card-body">
                        <!-- Main Search -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Search Query</label>
                            <div class="search-input-wrapper">
                                <div class="input-group">
                                    <input type="text" id="searchQuery" class="form-control" placeholder="e.g., LOADSTAR, 155/80, Apollo">
                                    <button class="btn btn-primary" onclick="performSearch()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div id="suggestions" class="suggestions-dropdown"></div>
                            </div>
                        </div>

                        <!-- Search Type -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Search Type</label>
                            <select id="searchType" class="form-select" onchange="updateSearchInterface()">
                                <option value="faceted" selected>Faceted Search</option>
                                <option value="basic">Basic Search</option>
                                <option value="highlighted">Highlighted Search</option>
                                <option value="cropped">Text Cropping</option>
                                <option value="browse">Browse Mode</option>
                            </select>
                        </div>

                        <!-- Advanced Options -->
                        <div class="accordion" id="advancedOptions">
                            <!-- Filters -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
                                        <i class="fas fa-filter"></i>&nbsp; Filters
                                    </button>
                                </h2>
                                <div id="filtersCollapse" class="accordion-collapse collapse" data-bs-parent="#advancedOptions">
                                    <div class="accordion-body">
                                        <div class="mb-2">
                                            <label class="form-label">Group</label>
                                            <select id="groupFilter" class="form-select form-select-sm">
                                                <option value="">All Groups</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">Record Type</label>
                                            <select id="recordTypeFilter" class="form-select form-select-sm">
                                                <option value="">All Types</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">Ply Rating</label>
                                            <select id="plyRatingFilter" class="form-select form-select-sm">
                                                <option value="">All Ratings</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">Custom Filter</label>
                                            <input type="text" id="customFilter" class="form-control form-control-sm" placeholder="e.g., group = 'SCV' AND record_type = 'Tyre'">
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Facets Panel -->
                <div class="card mt-3" id="facetsPanel" style="display: block;">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-pie"></i> Search Facets</h6>
                    </div>
                    <div class="card-body" id="facetsContent">
                        <!-- Facets will be populated here -->
                    </div>
                </div>

                <!-- Demo Search Section -->
                <div class="card mt-3 demo-search-section">
                    <div class="card-header">
                        <h6><i class="fas fa-play"></i> Quick Demo Searches</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="loadSampleSearch('LOADSTAR')">
                                <i class="fas fa-star"></i> Sample: LOADSTAR
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="loadSampleSearch('155/80')">
                                <i class="fas fa-tire"></i> Sample: 155/80 Size
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="browseMode()">
                                <i class="fas fa-th-large"></i> Browse All Categories
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="showAnalytics()">
                                <i class="fas fa-chart-bar"></i> Show Analytics
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-9">
                <!-- Selected Facets Display -->
                <div id="selectedFacetsContainer" class="mb-3" style="display: none;">
                    <div class="card">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center flex-wrap">
                                <span class="text-muted me-2">
                                    <i class="fas fa-filter"></i> Active Filters:
                                </span>
                                <div id="selectedFacetsTags" class="d-flex flex-wrap gap-1">
                                    <!-- Selected facet tags will be added here -->
                                </div>
                                <button class="btn btn-outline-secondary btn-sm ms-auto" onclick="clearAllFilters()" id="clearAllBtn">
                                    <i class="fas fa-times"></i> Clear All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Results Header -->
                <div class="card">
                    <div class="card-header search-controls-header">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <h5 class="mb-0">
                                    <i class="fas fa-list"></i> Search Results
                                    <span id="resultsCount" class="badge bg-secondary ms-2">0</span>
                                </h5>
                                <span id="processingTime" class="text-muted small"></span>
                            </div>
                            <div class="col-md-8">
                                <div class="row g-2 align-items-center justify-content-end">
                                    <!-- Sorting -->
                                    <div class="col-auto">
                                        <label class="form-label small mb-0">Sort:</label>
                                    </div>
                                    <div class="col-auto">
                                        <select id="sortField" class="form-select form-select-sm">
                                            <option value="">Relevance</option>
                                            <option value="size:asc">Size (A-Z)</option>
                                            <option value="size:desc">Size (Z-A)</option>
                                            <option value="ply_rating:asc">Ply Rating (Low-High)</option>
                                            <option value="ply_rating:desc">Ply Rating (High-Low)</option>
                                            <option value="title:asc">Title (A-Z)</option>
                                            <option value="title:desc">Title (Z-A)</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Results Per Page -->
                                    <div class="col-auto">
                                        <label class="form-label small mb-0">Show:</label>
                                    </div>
                                    <div class="col-auto">
                                        <select id="limitSelect" class="form-select form-select-sm">
                                            <option value="10">10</option>
                                            <option value="20" selected>20</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                            <option value="1000">Show All</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Display Options -->
                                    <div class="col-auto">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="highlightResults">
                                            <label class="form-check-label small" for="highlightResults">
                                                Highlight
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="showMatchPositions">
                                            <label class="form-check-label small" for="showMatchPositions">
                                                Positions
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alert for System Messages -->
                <div id="alertContainer"></div>

                <!-- Selected Facets Display -->
                <div id="selectedFacetsContainer" class="selected-facets-container" style="display: none;">
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <span class="text-muted small">Active Filters:</span>
                        <div id="selectedFacetsTags" class="d-flex flex-wrap gap-1">
                            <!-- Selected facet tags will be inserted here -->
                        </div>
                        <button class="btn btn-outline-secondary btn-sm ms-2" onclick="clearAllFilters()" title="Clear all filters">
                            <i class="fas fa-times"></i> Clear All
                        </button>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="searchResults" class="mt-3">
                    <!-- Welcome Message -->
                    <div class="card text-center" id="welcomeCard">
                        <div class="card-body py-5">
                            <i class="fas fa-tire fa-3x text-primary mb-3"></i>
                            <h3>Welcome to Apollo Tire Search</h3>
                            <p class="text-muted">Experience advanced search features including:</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled text-start">
                                        <li><i class="fas fa-check text-success"></i> Faceted Search & Analytics</li>
                                        <li><i class="fas fa-check text-success"></i> Advanced Boolean Filtering</li>
                                        <li><i class="fas fa-check text-success"></i> Multi-field Sorting</li>
                                        <li><i class="fas fa-check text-success"></i> Search Highlighting</li>
                                        <li><i class="fas fa-check text-success"></i> Intelligent Autocomplete</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled text-start">
                                        <li><i class="fas fa-check text-success"></i> Similar Product Recommendations</li>
                                        <li><i class="fas fa-check text-success"></i> Text Cropping & Custom Attributes</li>
                                        <li><i class="fas fa-check text-success"></i> Browse Mode & Analytics</li>
                                        <li><i class="fas fa-check text-success"></i> Real-time Performance Metrics</li>
                                        <li><i class="fas fa-check text-success"></i> 1,557 Apollo Tire Products</li>
                                    </ul>
                                </div>
                            </div>
                            <button class="btn btn-primary mt-3" onclick="loadSampleSearch('LOADSTAR')">
                                <i class="fas fa-play"></i> Try a Sample Search
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav id="pagination" class="mt-3" style="display: none;">
                    <ul class="pagination justify-content-center">
                        <!-- Pagination will be populated here -->
                    </ul>
                </nav>

                <!-- Similar Products Section -->
                <div id="similarProductsSection" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-lightbulb"></i> Similar Products</h6>
                        </div>
                        <div class="card-body" id="similarProductsContent">
                            <!-- Similar products will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="modal fade" id="analyticsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-bar"></i> Search Analytics & Statistics
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="analyticsContent">
                    <!-- Analytics content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configure API URL for different environments
        window.APOLLO_API_URL = 'http://localhost:8001';
        
        // Fallback search function in case main app fails to initialize
        window.fallbackSearch = async function() {
            console.log('🆘 Using fallback search function...');
            
            const query = document.getElementById('searchQuery')?.value?.trim() || '';
            const resultsContainer = document.getElementById('searchResults');
            
            if (!resultsContainer) {
                console.error('❌ Results container not found');
                return;
            }
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            // Show loading
            resultsContainer.innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"></div><span class="ms-2">Searching...</span></div>';
            
            try {
                const apiUrl = `http://localhost:8001/search?q=${encodeURIComponent(query)}&limit=10`;
                console.log('🔍 Fallback API call:', apiUrl);
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('✅ Fallback search successful:', data);
                
                // Display results
                if (!data.hits || data.hits.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No results found for "${query}".
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="alert alert-success">
                        <h5>Search Results (Fallback Mode)</h5>
                        <p>Found ${data.hits.length} results for "<strong>${query}</strong>" 
                           ${data.processing_time_ms ? `(${data.processing_time_ms}ms)` : ''}</p>
                    </div>
                    <div class="row">
                `;
                
                data.hits.forEach(product => {
                    const title = product.title || product.pattern_model || 'Unknown Product';
                    const brand = product.brand || 'Unknown Brand';
                    const size = product.size || 'N/A';
                    const category = product.category || 'Unknown Category';
                    const group = product.group || 'Unknown';
                    
                    html += `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">${title}</h6>
                                    <p class="card-text">
                                        <strong>Brand:</strong> ${brand}<br>
                                        <strong>Size:</strong> ${size}<br>
                                        <strong>Category:</strong> ${category}<br>
                                        <strong>Group:</strong> ${group}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                resultsContainer.innerHTML = html;
                
                console.log(`✅ Displayed ${data.hits.length} results via fallback`);
                
            } catch (error) {
                console.error('❌ Fallback search failed:', error);
                resultsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Search Error</h5>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Query:</strong> "${query}"</p>
                    </div>
                `;
            }
        };
        
        // Override performSearch if it doesn't exist after 3 seconds
        setTimeout(() => {
            if (typeof window.performSearch !== 'function') {
                console.warn('⚠️ Main performSearch not available, using fallback');
                window.performSearch = window.fallbackSearch;
            }
        }, 3000);
    </script>
    <!-- Modular JavaScript architecture -->
    <script src="js/api-config.js"></script>
    <script src="js/health-checker.js"></script>
    <script src="js/search-manager.js"></script>
    <script src="js/event-handler.js"></script>
    <script src="js/filter-manager.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
