<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug API Connection</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>API Connection Debug Tool</h1>
    
    <div id="apiUrl" class="log">Detecting API URL...</div>
    
    <div>
        <button onclick="testApiConnection()">Test API Connection</button>
        <button onclick="testHealthCheck()">Test Health Check</button>
        <button onclick="testSearch()">Test Search</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="logs"></div>

    <script>
        let apiBaseUrl = null;

        function log(message, type = 'info') {
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').appendChild(logDiv);
            console.log(`[${type}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function detectApiUrl() {
            // Check if injected by server
            if (window.APOLLO_API_URL) {
                log(`üéØ Server-injected API URL: ${window.APOLLO_API_URL}`, 'success');
                return window.APOLLO_API_URL;
            }
            
            // Auto-detect based on current location
            const currentLocation = window.location;
            const hostname = currentLocation.hostname;
            const protocol = currentLocation.protocol;
            
            log(`üìç Current location: ${protocol}//${hostname}:${currentLocation.port}`, 'info');
            
            // Check for cloudflare
            if (hostname.includes('cloudflare')) {
                const apiUrl = `${protocol}//${currentLocation.host}/api`;
                log(`‚òÅÔ∏è Detected Cloudflare, using proxy: ${apiUrl}`, 'success');
                return apiUrl;
            }
            
            // Local fallback
            const localUrl = 'http://localhost:8001';
            log(`üè† Using local fallback: ${localUrl}`, 'warning');
            return localUrl;
        }

        function getApiEndpoint(path) {
            const baseUrl = apiBaseUrl;
            if (baseUrl.includes('/api')) {
                const cleanPath = path.startsWith('/') ? path.substring(1) : path;
                return `${baseUrl}/${cleanPath}`;
            } else {
                const cleanPath = path.startsWith('/') ? path : `/${path}`;
                return `${baseUrl}${cleanPath}`;
            }
        }

        async function testApiConnection() {
            log('üîç Starting API connection test...', 'info');
            try {
                const response = await fetch(apiBaseUrl);
                log(`üì° Response status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`üìã Response headers: ${JSON.stringify(Object.fromEntries(response.headers))}`, 'info');
            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        async function testHealthCheck() {
            log('ü©∫ Testing health check endpoint...', 'info');
            try {
                const healthUrl = getApiEndpoint('health');
                log(`üîó Health URL: ${healthUrl}`, 'info');
                
                const response = await fetch(healthUrl);
                log(`üì° Health response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Health data: ${JSON.stringify(data)}`, 'success');
                } else {
                    const text = await response.text();
                    log(`‚ùå Health error: ${text}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Health check failed: ${error.message}`, 'error');
            }
        }

        async function testSearch() {
            log('üîç Testing search endpoint...', 'info');
            try {
                const searchUrl = getApiEndpoint('search?q=tire&limit=3');
                log(`üîó Search URL: ${searchUrl}`, 'info');
                
                const response = await fetch(searchUrl);
                log(`üì° Search response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Search results: ${data.hits.length} hits found`, 'success');
                } else {
                    const text = await response.text();
                    log(`‚ùå Search error: ${text}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Search failed: ${error.message}`, 'error');
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            apiBaseUrl = detectApiUrl();
            document.getElementById('apiUrl').innerHTML = `Detected API URL: <strong>${apiBaseUrl}</strong>`;
            
            log('üöÄ Debug tool initialized', 'success');
            log(`üåê User Agent: ${navigator.userAgent}`, 'info');
            log(`üìç Location: ${window.location.href}`, 'info');
        });
    </script>
</body>
</html>
